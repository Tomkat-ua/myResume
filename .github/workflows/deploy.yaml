# .github/workflows/deploy.yml
name: Deploy to VPS Server

on:
  push:
    branches:
      - master  # –ó–∞–ø—É—Å–∫–∞—Ç–∏ –¥–µ–ø–ª–æ–π –ø—Ä–∏ –ø—É—à—ñ –≤ –≥—ñ–ª–∫—É master

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. –û—Ç—Ä–∏–º–∞—Ç–∏ –∫–æ–¥ –∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—é GitHub
      - name: Checkout code üì•
        uses: actions/checkout@v4

      #  –í–∏–∫–æ–Ω–∞—Ç–∏ –∑–±—ñ—Ä–∫—É, —è–∫—â–æ —Ü–µ –Ω–µ–æ–±—Ö—ñ–¥–Ω–æ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –¥–ª—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥—É)
      # - name: Build Project
      #   run: npm install && npm run build

      # 2. –í–∏–∑–Ω–∞—á–µ–Ω–Ω—è –∑–º—ñ–Ω–Ω–æ—ó –≤–µ—Ä—Å—ñ—ó
      # –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –∫–æ—Ä–æ—Ç–∫–∏–π —Ö–µ—à –∫–æ–º—ñ—Ç—É —è–∫ —Ç–µ–≥ –≤–µ—Ä—Å—ñ—ó
      - name: Set Image Tag
        id: set_tag
        run: echo "IMAGE_TAG=$(git rev-parse --short ${{ github.sha }})" >> $GITHUB_ENV

      # 3. –î–µ–ø–ª–æ–π —á–µ—Ä–µ–∑ SSH
      - name: Deploy via SSH üöÄ
        uses: appleboy/ssh-action@v1.0.3 # –ü–æ–ø—É–ª—è—Ä–Ω–∏–π action –¥–ª—è SSH
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          envs: IMAGE_TAG
          script: |
            # 1. –ü–µ—Ä–µ–π—Ç–∏ –¥–æ —Ä–æ–±–æ—á–æ—ó –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—ó –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ
            cd /home/tomkat/docker_img/myResume/
            
            # 2. –û–Ω–æ–≤–∏—Ç–∏ –∫–æ–¥ –∑ GitHub
            # –Ø–∫—â–æ –≤–∏ –≤–∂–µ –æ–¥–∏–Ω —Ä–∞–∑ –∑—Ä–æ–±–∏–ª–∏ git clone –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ:
            git pull origin master
            echo "Current Image Tag is: $IMAGE_TAG"

            # 3. –î–æ–¥–∞—Ç–∫–æ–≤—ñ –∫–æ–º–∞–Ω–¥–∏ –ø—ñ—Å–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è:
            sudo bash ./build.sh $IMAGE_TAG
            sudo bash ./run.sh $IMAGE_TAG
